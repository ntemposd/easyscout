{% extends "base.html" %}
{% block title %}Easyscout â€” Scouting Report{% endblock %}

{% block body %}
<main class="max-w-6xl mx-auto px-4 py-2" style="overflow-x: hidden;">

  <!--<header class="space-y-2">
     <h1 class="text-3xl font-bold">Scouting Reports</h1>
    <p class="text-sm text-zinc-600">
      Generate a scouting report from a player name. Cache-first. Web search optional. 
    </p>
  </header>-->

  <!-- App-only user badge (index-only bubble) -->
  <div class="mb-4">
    <span id="user_badge" class="inline-block rounded-full bg-white border border-zinc-200 py-2 px-4 text-sm text-zinc-700 shadow-sm" style="font-size: 0;">Not signed in</span>
  </div>
  
  <!-- Layout -->
  <div class="grid gap-4" data-no-cls style="overflow-x: hidden;">
    <!-- MAIN (2/3) -->
    <div class="space-y-4" style="min-width: 0;">

      <!-- Generate -->
      <div class="space-y-0 mt-0">
          <h2 class="text-3xl font-extrabold tracking-tight section-title">Generate a report</h2>
          <p class="text-base section-desc">Enter a player name and optional team.</p>
      </div>
      <!--Reports are cache-first; enable web search to include broader sources.-->
      <section class="bg-white border border-zinc-200 rounded-xl p-6 shadow-sm">
        <form id="scout-form" class="space-y-4" novalidate>

          <div class="grid sm:grid-cols-2 gap-3">
            <div>
              <label for="player" class="block text-sm font-medium">Player *</label>
              <input id="player" name="player" required type="text" placeholder="e.g., Giannis Antetokounmpo"
                class="mt-1 w-full rounded-md border bg-white border-zinc-300 px-3 py-2 text-sm shadow-sm focus:outline-none focus:ring-2 focus:ring-[#6FD06B]" />
            </div>

            <div>
              <label for="team" class="block text-sm font-medium">Team</label>
              <input id="team" name="team" type="text" placeholder="e.g., Milwaukee Bucks"
                class="mt-1 w-full rounded-md border bg-white border-zinc-300 px-3 py-2 text-sm shadow-sm focus:outline-none focus:ring-2 focus:ring-[#6FD06B]" />
            </div>

            <!--<div>
              <label for="league" class="block text-sm font-medium">League</label>
              <input id="league" name="league" type="text" placeholder="e.g., GBL / EuroCup"
                class="mt-1 w-full rounded-md border bg-white border-zinc-300 px-3 py-2 text-sm shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500" />
            </div>

            <div>
              <label for="season" class="block text-sm font-medium">Season</label>
              <input id="season" name="season" type="text" placeholder="e.g., 2025-26"
                class="mt-1 w-full rounded-md border bg-white border-zinc-300 px-3 py-2 text-sm shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500" />
            </div>-->
          </div>

          <fieldset class="flex flex-col sm:flex-row gap-3 text-sm">
            <label class="inline-flex items-center gap-2 hidden">
              <input id="use_web" type="checkbox"
                class="rounded border-zinc-300 text-blue-600 focus:ring-blue-500" />
              Use web search (costs more)
            </label>

            <label class="inline-flex items-center gap-2">
              <input id="refresh" type="checkbox"
                class="rounded border-zinc-300 text-[#6FD06B] focus:ring-[#6FD06B]" />
              Ignore saved report
            </label>
          </fieldset>

          <div class="flex items-center flex-wrap gap-2">
            <button type="button" id="run"
              class="btn-primary disabled:opacity-50">
              Generate
            </button>

            <!--<button type="button" id="example"
              class="bg-zinc-200 text-zinc-900 px-4 py-2 rounded-md text-sm hover:bg-zinc-300">
              Fill example
            </button>-->

            <span class="flex-1"></span>

            <span id="badge"
              class="hidden text-sm px-3 py-1 rounded-full border border-zinc-300 text-zinc-600"
              aria-live="polite"></span>
            <span id="status" class="text-sm text-zinc-500" aria-live="polite"></span>
          </div>

          <div id="err" class="text-sm text-red-600" role="alert"></div>
          <div id="suggestion_box" class="hidden mt-3 p-3 border border-[#C1D9C7] rounded-md bg-[#E8F4EB] text-sm">
            <div id="suggestion_text" class="mb-2 text-zinc-800"></div>
            <div class="flex gap-2">
              <button type="button" id="suggest_accept" class="btn-primary">Use saved report</button>
              <button type="button" id="suggest_reject" class="btn-secondary">Generate new</button>
              <button type="button" id="suggest_close" class="ml-auto btn-dismiss">Dismiss</button>
            </div>
          </div>
        </form>
      </section>

      <!-- Output -->
      <div class="space-y-0 mt-0">
          <h2 class="text-3xl font-extrabold tracking-tight section-title">Report</h2>
          <p class="text-base section-desc">Use the Generate button to create a report.</p>
      </div>
      <section class="bg-white border border-zinc-200 rounded-xl p-6 shadow-sm relative" style="min-width: 0;">
        <!-- Loader moved to report pane so it doesn't block the form suggestion UI -->
        <div id="report_loader" class="hidden absolute inset-0 z-10 bg-white/70 flex items-center justify-center">
          <div class="flex items-center gap-2">
            <svg class="animate-spin h-6 w-6 text-[#0E2018]" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
            </svg>
            <div class="text-sm text-zinc-700">Generating reportâ€¦</div>
          </div>
        </div>
        <div id="out_html" class="space-y-3" style="max-width: 100%; overflow-x: hidden;">
          <div class="text-sm text-zinc-500">No report yet.</div>
        </div>

        <pre id="out_md" class="hidden"></pre>
      </section>

    </div>

    <!-- SIDEBAR (1/3): My Reports -->
    <aside class="space-y-4">
      <div class="space-y-0 mt-0">
          <h2 class="text-3xl font-extrabold tracking-tight section-title">My reports <span id="reports_count" class="inline items-center rounded-md bg-[#6FD06B]/10 px-2 py-1 text-2xl text-[#6FD06B] ring-1 ring-inset ring-[#6FD06B]/20"></span></h2>
          <p class="text-base section-desc">Search and open your saved reports.</p>
      </div>
      <section class="bg-white border border-zinc-200 rounded-xl p-6 shadow-sm space-y-3">
        <div class="flex items-center justify-between">
          
        </div>

        <div class="space-y-1">
          <label for="report_q" class="block text-sm font-medium">Search</label>
          <input id="report_q" type="text" placeholder="Search position, player, team, leagueâ€¦"
            class="w-full rounded-md border bg-white border-zinc-300 px-3 py-2 text-sm shadow-sm focus:outline-none focus:ring-2 focus:ring-[#6FD06B]" />
          <div class="text-xs text-zinc-500">
            Click a report to open it.
          </div>
        </div>

        <div class="border-t border-zinc-200 pt-4">
          <div id="reports_list" class="space-y-1">
            <div class="text-sm text-zinc-500">Loadingâ€¦</div>
          </div>
        </div>
      </section>
    </aside>
  </div>

  <!-- Credits Modal -->
  <div id="credits_modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/50">
    <div class="bg-white rounded-xl shadow-xl max-w-md w-full mx-4 p-6">
      <div class="flex items-start justify-between mb-4">
        <h3 class="text-2xl font-bold">Top up credits</h3>
        <button type="button" id="close_credits_modal" class="text-zinc-400 hover:text-zinc-600">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
      
      <div class="space-y-4">
        <div class="flex items-start justify-between gap-3 p-4 bg-zinc-50 rounded-lg">
          <div>
            <div class="text-sm text-zinc-500">Current balance</div>
            <div id="modal_credits_badge" class="text-3xl font-extrabold text-[#6FD06B]">â€”</div>
            <div class="text-xs text-zinc-500 mt-1">1 credit = â‚¬1</div>
          </div>
        </div>

        <div class="grid grid-cols-2 gap-2">
          <button type="button" id="modal_buy5" class="col-span-1 btn-primary">
            Buy 5 credits
          </button>

          <button type="button" id="modal_buy10" class="col-span-1 btn-primary">
            Buy 10 credits
          </button>

          <div class="col-span-2 flex gap-2 items-center">
            <input id="modal_custom_credits" type="number" min="1" max="1000" value="5"
              class="flex-1 rounded-md border bg-white border-zinc-300 px-3 py-2 text-sm shadow-sm focus:outline-none focus:ring-2 focus:ring-[#6FD06B]" />
            <button type="button" id="modal_buyCustom" class="btn-primary">
              Buy custom
            </button>
          </div>
        </div>

        <div id="modal_buy_err" class="text-sm text-red-600"></div>
      </div>
    </div>
  </div>

</main>
{% endblock %}

{% block scripts %}
<script>
  (function() {
    if (!window.sb || !window.sb.auth) {
      console.warn("Supabase not ready");
      return;
    }

    // Debounce report search input
    const reportQ = document.getElementById('report_q');
    if (reportQ) {
      let timer = null;
      reportQ.addEventListener('input', function () {
        if (timer) clearTimeout(timer);
        timer = setTimeout(() => {
          window.loadReports(reportQ.value || '');
        }, 350);
      });
    }

    const userBadge = document.getElementById("user_badge");
    const loginLink = document.getElementById("login_link");
    const logoutBtn = document.getElementById("logout_btn");
    const creditsModal = document.getElementById("credits_modal");
    const runBtn = document.getElementById("run");
    let currentCredits = null;

    function renderLoggedOut() {
      userBadge.innerHTML = "Not signed in";
      loginLink.style.display = "inline";
      logoutBtn.style.display = "none";
      if (runBtn) runBtn.textContent = "Generate";
    }

    function renderLoggedIn(session, credits = null) {
      const email = session?.user?.email || "User";
      const name = email.split('@')[0];
      const creditsText = credits !== null ? credits : "â€”";
      const creditWord = credits === 1 ? 'credit' : 'credits';
      userBadge.innerHTML = `<span style="font-size: 0.875rem;">Hi ${name}! You have <a href="#" id="topup_link">${creditsText} ${creditWord}</a>.</span>`;
      const link = document.getElementById("topup_link");
      link.style.color = "rgb(37, 99, 235)";
      link.style.fontWeight = "600";
      link.style.fontSize = "0.875rem";
      link.addEventListener('click', (e) => {
        e.preventDefault();
        if (creditsModal) creditsModal.classList.remove("hidden");
      });
      link.addEventListener('mouseover', (e) => {
        e.target.style.textDecoration = 'underline';
      });
      link.addEventListener('mouseout', (e) => {
        e.target.style.textDecoration = 'none';
      });
      loginLink.style.display = "none";
      logoutBtn.style.display = "inline";
    }

    // Deduplicate rapid credit queries: reuse an in-flight promise and cache
    // the last value for a short window to avoid repeated requests on refresh.
    window._creditsCache = window._creditsCache || { ts: 0, val: null };
    window._creditsPromise = window._creditsPromise || null;

    async function fetchCredits(token) {
      // simple TTL cache: 3 seconds
      try {
        const now = Date.now();
        if (window._creditsCache && (now - (window._creditsCache.ts || 0) < 3000)) {
          return window._creditsCache.val;
        }

        if (window._creditsPromise) {
          return await window._creditsPromise;
        }

        window._creditsPromise = (async () => {
          try {
            const r = await fetch("/api/credits", { headers: { Authorization: `Bearer ${token}` } });
            if (!r.ok) return null;
            const j = await r.json();
            const v = typeof j.credits === "number" ? j.credits : null;
            window._creditsCache = { ts: Date.now(), val: v };
            return v;
          } catch {
            return null;
          } finally {
            window._creditsPromise = null;
          }
        })();

        return await window._creditsPromise;
      } catch {
        return null;
      }
    }

    async function refreshCreditsForSession(session) {
      if (!session?.access_token) {
        currentCredits = null;
        if (runBtn) runBtn.textContent = "Generate";
        return;
      }
      
      const credits = await fetchCredits(session.access_token);
      currentCredits = credits;
      
      // Re-render the speech bubble with updated credits
      const email = session?.user?.email || "User";
      const name = email.split('@')[0];
      const creditsText = credits !== null ? credits : "â€”";
      const creditWord = credits === 1 ? 'credit' : 'credits';
      userBadge.innerHTML = `<span style="font-size: 0.875rem;">Hi ${name}! You have <a href="#" id="topup_link">${creditsText} ${creditWord}</a>.</span>`;
      const link = document.getElementById("topup_link");
      link.style.color = "rgb(37, 99, 235)";
      link.style.fontWeight = "600";
      link.style.fontSize = "0.875rem";
      link.addEventListener('click', (e) => {
        e.preventDefault();
        if (creditsModal) creditsModal.classList.remove("hidden");
      });
      link.addEventListener('mouseover', (e) => {
        e.target.style.textDecoration = 'underline';
      });
      link.addEventListener('mouseout', (e) => {
        e.target.style.textDecoration = 'none';
      });
      
      // Update modal
      const modalCredits = document.getElementById("modal_credits_badge");
      if (modalCredits) {
        modalCredits.textContent = creditsText;
      }
      
      // Update Generate button text based on credits
      if (runBtn) {
        if (credits === 0) {
          runBtn.textContent = "Top-up to generate report";
        } else {
          runBtn.textContent = "Generate";
        }
      }
    }

    // Expose for other code paths (app.js + checkout + reports)
    window.getAccessToken = async function () {
      if (!window.sb || !window.sb.auth) return null;
      const { data } = await window.sb.auth.getSession();
      return data?.session?.access_token || null;
    };

    // Removed logoutBtn click handler to let base.html handle logout globally
    // logoutBtn?.addEventListener("click", () => {
    //   try { window.sb.auth.signOut().catch(() => {}); } catch (e) {}
    //   // Redirect immediately to the public landing
    //   window.location.replace('/');
    // });

    // ---- Reports sidebar ----
    async function openReport(reportId) {
      const err = document.getElementById("err");
      if (err) err.textContent = "";

      // Track report click
      try {
        window.trackClientEvent?.('report_clicked', { report_id: reportId });
      } catch (e) {}

      const token = await window.getAccessToken?.();
      if (!token) return;

      const r = await fetch(`/api/reports/${reportId}`, {
        headers: { Authorization: `Bearer ${token}` }
      });

      const payload = await r.json().catch(() => ({}));
      if (!r.ok) {
        if (err) err.textContent = payload.error || "Failed to open report";
        return;
      }

      // Prefer your rich renderer from app.js if present
      const out = document.getElementById("out_html");
      if (typeof window.renderReport === "function") {
        out.innerHTML = window.renderReport(payload);
      } else {
        out.innerHTML = `<pre class="text-sm whitespace-pre-wrap">${(payload.report_md || "")}</pre>`;
      }

      // Enable drag-to-scroll on loaded report tables
      if (typeof window.enableTableDragScroll === "function") {
        window.enableTableDragScroll();
      }

      // Scroll the report title into view and align it under the sticky header
      try {
        const out = document.getElementById('out_html');
        if (out) {
          const titleEl = out.querySelector('.text-2xl, h1, h2, .report-title');
          const target = titleEl || out;
          if (target) {
            const rect = target.getBoundingClientRect();
            const header = document.querySelector('header');
            const headerH = header ? header.getBoundingClientRect().height : 0;
            const y = window.scrollY + rect.top - headerH - 8; // small gap
            window.scrollTo({ top: Math.max(0, Math.round(y)), behavior: 'smooth' });
          }
        }
      } catch (e) {}

      const badge = document.getElementById("badge");
      const status = document.getElementById("status");
      if (badge) badge.textContent = "ðŸ“š Loaded from library";
      if (status) status.textContent = "";
    }

    window.loadReports = async function loadReports(q = "") {
      const list = document.getElementById("reports_list");
      const count = document.getElementById("reports_count");
      if (!list) return;

      const token = await window.getAccessToken?.();
      if (!token) {
        list.innerHTML = `<div class="text-sm text-zinc-500">Login to see your saved reports.</div>`;
        if (count) count.textContent = "";
        return;
      }

      const url = new URL("/api/reports", window.location.origin);
      url.searchParams.set("limit", "30");
      if (q) url.searchParams.set("q", q);

      // In-memory client-side cache to avoid repeated sidebar requests
      window._reportsCache = window._reportsCache || { ts: 0, data: null, ttl: 5000 };
      const now = Date.now();
      if (!q && window._reportsCache.data && (now - window._reportsCache.ts) < window._reportsCache.ttl) {
        renderReportsFromCache(window._reportsCache.data);
        return;
      }

      // insert skeleton placeholders to reserve space and avoid layout shift
      list.innerHTML = `
        <div class="reports-skeleton" aria-hidden="true">
          <div class="s-item"></div>
          <div class="s-item"></div>
          <div class="s-item"></div>
          <div class="s-item"></div>
        </div>
      `;
      try { list.style.minHeight = '240px'; } catch (e) {}

      const r = await fetch(url.toString(), {
        headers: { Authorization: `Bearer ${token}` }
      });

      const j = await r.json().catch(() => ({}));
      if (!r.ok) {
        list.innerHTML = `<div class="text-sm text-red-600">${j.error || "Failed to load reports"}</div>`;
        if (count) count.textContent = "";
        return;
      }

      const items = j.items || [];
      if (r.ok && !q) {
        try { window._reportsCache = { ts: Date.now(), data: items, ttl: 5000 }; } catch (e) {}
      }

      // Deduplicate by player name (normalized) and keep the latest report per player
      const byName = new Map();
      for (const it of items) {
        const name = (it.player_name || "").trim().toLowerCase();
        if (!name) continue;
        const existing = byName.get(name);
        if (!existing) {
          byName.set(name, it);
          continue;
        }
        const a = new Date(it.created_at || 0);
        const b = new Date(existing.created_at || 0);
        if (a > b) byName.set(name, it);
      }

      const deduped = Array.from(byName.values()).sort((a, b) => {
        return new Date(b.created_at || 0) - new Date(a.created_at || 0);
      });

      if (count) count.textContent = deduped.length ? `${deduped.length}` : "";

      if (!deduped.length) {
        list.innerHTML = `<div class="text-sm text-zinc-500">No saved reports yet.</div>`;
        return;
      }

      list.innerHTML = deduped.map(it => {
        let dateStr = "";
        if (it.created_at) {
          try {
            const d = new Date(it.created_at);
            dateStr = d.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
          } catch (e) {
            dateStr = it.created_at.split('T')[0];
          }
        }
        return `
        <button
          type="button"
          class="report-item w-full text-left text-sm px-3 py-2 rounded-md border border-zinc-200 hover:bg-zinc-50"
          data-report-id="${it.id}">
          <div class="font-medium">${it.player_name || "Report"}</div>
          ${it.position ? `<div class="text-xs text-zinc-500">${it.position}</div>` : ''}
        </button>
      `;
      }).join("");

      // attach handlers and animate items into view
      const nodes = Array.from(list.querySelectorAll("button[data-report-id]"));
      nodes.forEach(btn => btn.addEventListener("click", () => openReport(btn.dataset.reportId)));
      // Ensure clicks reach items even on mobile when layout/overlays change: event-delegate at container level
      list.onclick = function (e) {
        try {
          const btn = (e.target && e.target.closest) ? e.target.closest('button[data-report-id]') : null;
          if (btn) {
            openReport(btn.dataset.reportId);
          }
        } catch (err) {}
      };
      // trigger CSS transition
      requestAnimationFrame(() => nodes.forEach(n => n.classList.add('visible')));
      try { list.style.minHeight = ''; } catch (e) {}
    };

    function renderReportsFromCache(items) {
      const list = document.getElementById("reports_list");
      const count = document.getElementById("reports_count");
      if (!list) return;
      const byName = new Map();
      for (const it of items) {
        const name = (it.player_name || "").trim().toLowerCase();
        if (!name) continue;
        const existing = byName.get(name);
        if (!existing) { byName.set(name, it); continue; }
        const a = new Date(it.created_at || 0);
        const b = new Date(existing.created_at || 0);
        if (a > b) byName.set(name, it);
      }
      const deduped = Array.from(byName.values()).sort((a, b) => new Date(b.created_at || 0) - new Date(a.created_at || 0));
      if (count) count.textContent = deduped.length ? `${deduped.length}` : "";
      if (!deduped.length) { list.innerHTML = `<div class="text-sm text-zinc-500">No saved reports yet.</div>`; return; }
      list.innerHTML = deduped.map(it => {
        let dateStr = "";
        if (it.created_at) {
          try {
            const d = new Date(it.created_at);
            dateStr = d.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
          } catch (e) {
            dateStr = it.created_at.split('T')[0];
          }
        }
        return `
        <button
          type="button"
          class="report-item w-full text-left text-sm px-3 py-2 rounded-md border border-zinc-200 hover:bg-zinc-50"
          data-report-id="${it.id}">
          <div class="font-medium">${it.player_name || "Report"}</div>
          ${it.position ? `<div class="text-xs text-zinc-500">${it.position}</div>` : ''}
        </button>
      `;
      }).join("");
      const nodes = Array.from(list.querySelectorAll("button[data-report-id]"));
      nodes.forEach(btn => btn.addEventListener("click", () => openReport(btn.dataset.reportId)));
      list.onclick = function (e) {
        try {
          const btn = (e.target && e.target.closest) ? e.target.closest('button[data-report-id]') : null;
          if (btn) { openReport(btn.dataset.reportId); }
        } catch (err) {}
      };
      requestAnimationFrame(() => nodes.forEach(n => n.classList.add('visible')));
    }

    // Debounced search
    let _rt = null;
    document.getElementById("report_q")?.addEventListener("input", (e) => {
      clearTimeout(_rt);
      _rt = setTimeout(() => window.loadReports(e.target.value.trim()), 250);
    });

    // Initial render
    (async () => {
      if (!window.sb || !window.sb.auth) return;
      const { data } = await window.sb.auth.getSession();
      const session = data?.session || null;

      if (!session) {
        renderLoggedOut();
        window.loadReports(""); // will show login message
        return;
      }

      // Fetch credits first, then render with the value
      const credits = await fetchCredits(session.access_token);
      currentCredits = credits;
      renderLoggedIn(session, credits);
      
      // Update modal and button
      const modalCredits = document.getElementById("modal_credits_badge");
      if (modalCredits) modalCredits.textContent = (credits ?? "â€”");
      if (runBtn) {
        runBtn.textContent = credits === 0 ? "Top-up to generate report" : "Generate";
      }
      
      window.loadReports("");
    })();

    // Auth changes
    if (window.sb && window.sb.auth) {
      window.sb.auth.onAuthStateChange(async (_event, session) => {
        if (!session) {
          renderLoggedOut();
          window.loadReports("");
          return;
        }
        
        // Fetch credits first, then render with the value
        const credits = await fetchCredits(session.access_token);
        currentCredits = credits;
        renderLoggedIn(session, credits);
        
        // Update modal and button
        const modalCredits = document.getElementById("modal_credits_badge");
        if (modalCredits) modalCredits.textContent = (credits ?? "â€”");
        if (runBtn) {
          runBtn.textContent = credits === 0 ? "Top-up to generate report" : "Generate";
        }
        
        window.loadReports(document.getElementById("report_q")?.value?.trim() || "");
      });
    }
  })();
</script>

<!-- Stripe checkout helper -->
<script>
  // Modal controls
  document.getElementById("close_credits_modal")?.addEventListener("click", () => {
    const modal = document.getElementById("credits_modal");
    if (modal) modal.classList.add("hidden");
  });

  // Close modal on backdrop click
  document.getElementById("credits_modal")?.addEventListener("click", (e) => {
    if (e.target.id === "credits_modal") {
      e.target.classList.add("hidden");
    }
  });

  async function startCheckout(credits, errId) {
    const err = document.getElementById(errId || "modal_buy_err");
    if (err) err.textContent = "";

    const n = parseInt(String(credits || 0), 10);
    if (!Number.isFinite(n) || n <= 0 || n > 1000) {
      if (err) err.textContent = "Enter a number between 1 and 1000.";
      return;
    }

    const token = await window.getAccessToken?.();
    if (!token) {
      window.location.href = "/login";
      return;
    }

    const r = await fetch("/api/stripe/create-checkout-session", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": `Bearer ${token}`
      },
      body: JSON.stringify({ credits: n })
    });

    const j = await r.json().catch(() => ({}));
    if (!r.ok) {
      if (err) err.textContent = j.error || "Failed to start checkout";
      return;
    }

    window.location.href = j.url;
  }

  // Modal buttons
  document.getElementById("modal_buy5")?.addEventListener("click", () => startCheckout(5, "modal_buy_err"));
  document.getElementById("modal_buy10")?.addEventListener("click", () => startCheckout(10, "modal_buy_err"));
  document.getElementById("modal_buyCustom")?.addEventListener("click", () => {
    const n = parseInt(document.getElementById("modal_custom_credits").value || "0", 10);
    startCheckout(n, "modal_buy_err");
  });

  // Handle Generate button click when credits are 0
  document.getElementById("run")?.addEventListener("click", (e) => {
    const btn = e.target;
    if (btn.textContent.includes("Top-up")) {
      e.preventDefault();
      const modal = document.getElementById("credits_modal");
      if (modal) modal.classList.remove("hidden");
    }
  });
</script>

{{ super() }}
{% endblock %}
