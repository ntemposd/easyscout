{% extends "base.html" %}
{% block title %}Easyscout - Scouting Reports{% endblock %}

{% block body %}
<main class="max-w-6xl mx-auto px-4 py-2" style="overflow-x: hidden;">

  <!--<header class="space-y-2">
     <h1 class="text-3xl font-bold">Scouting Reports</h1>
    <p class="text-sm text-zinc-600">
      Generate a scouting report from a player name. Cache-first. Web search optional. 
    </p>
  </header>-->

  <!-- App-only user badge (index-only bubble) -->
  <div class="mb-4">
    <span id="user_badge"></span>
  </div>
  
  <!-- Layout -->
  <div class="grid gap-4" data-no-cls style="overflow-x: hidden;">
    <!-- MAIN (2/3) -->
    <div class="space-y-4" style="min-width: 0;">

      <!-- Generate -->
      <div class="space-y-0 mt-0">
          <h2 class="text-3xl font-extrabold tracking-tight section-title">New report</h2>
          <p class="text-base section-desc">Create a pro-grade report.</p>
      </div>
      <!--Reports are cache-first; enable web search to include broader sources.-->
      <section class="bg-white border border-zinc-200 rounded-xl p-6 shadow-sm">
        <form id="scout-form" class="space-y-4" novalidate>

          <div class="grid sm:grid-cols-2 gap-3">
            <div>
              <label for="player" class="block text-sm font-medium">Player *</label>
              <input id="player" name="player" required type="text" placeholder="e.g., Giannis Antetokounmpo"
                class="mt-1 w-full rounded-md border bg-white border-zinc-300 px-3 py-2 text-sm shadow-sm focus:outline-none focus:ring-2 focus:ring-[#6FD06B]" />
            </div>

            <div>
              <label for="team" class="block text-sm font-medium">Team</label>
              <input id="team" name="team" type="text" placeholder="e.g., Milwaukee Bucks"
                class="mt-1 w-full rounded-md border bg-white border-zinc-300 px-3 py-2 text-sm shadow-sm focus:outline-none focus:ring-2 focus:ring-[#6FD06B]" />
            </div>

            <!--<div>
              <label for="league" class="block text-sm font-medium">League</label>
              <input id="league" name="league" type="text" placeholder="e.g., GBL / EuroCup"
                class="mt-1 w-full rounded-md border bg-white border-zinc-300 px-3 py-2 text-sm shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500" />
            </div>

            <div>
              <label for="season" class="block text-sm font-medium">Season</label>
              <input id="season" name="season" type="text" placeholder="e.g., 2025-26"
                class="mt-1 w-full rounded-md border bg-white border-zinc-300 px-3 py-2 text-sm shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500" />
            </div>-->
          </div>

          <fieldset class="flex flex-col sm:flex-row gap-3 text-sm">
            <label class="inline-flex items-center gap-2 hidden">
              <input id="use_web" type="checkbox"
                class="rounded border-zinc-300 text-blue-600 focus:ring-blue-500" />
              Use web search (costs more)
            </label>

            <!--<label class="inline-flex items-center gap-2">
              <input id="refresh" type="checkbox"
                class="rounded border-zinc-300 text-[#6FD06B] focus:ring-[#6FD06B]" />
              Update with latest data
            </label>-->
          </fieldset>

          <div class="flex items-center flex-wrap gap-2">
            <button type="button" id="run"
              class="btn-primary disabled:opacity-50">
              Generate report
            </button>
            <!--<p class="text-sm">1 credit.</p>-->

            <!--<button type="button" id="example"
              class="bg-zinc-200 text-zinc-900 px-4 py-2 rounded-md text-sm hover:bg-zinc-300">
              Fill example
            </button>-->

            <span class="flex-1"></span>
          </div>

          <div id="err" class="text-sm text-red-600" role="alert"></div>
          <div id="suggestion_box" class="hidden mt-3 p-3 border border-[#C1D9C7] rounded-md bg-[#E8F4EB] text-sm">
            <div id="suggestion_text" class="mb-3 text-zinc-800 font-medium"></div>
            <div class="flex gap-2">
              <button type="button" id="suggest_accept" class="btn-primary">Yes</button>
              <button type="button" id="suggest_reject" class="btn-secondary">No</button>
            </div>
          </div>
        </form>
      </section>

      <!-- Output -->
      <div class="space-y-0 mt-0">
          <h2 class="text-3xl font-extrabold tracking-tight section-title">Player report</h2>
          <p class="text-base section-desc">Key traits, stats, and role.</p>
      </div>
      <section class="bg-white border border-zinc-200 rounded-xl p-6 shadow-sm relative" style="min-width: 0;">
        <!-- Status notification (top right) -->
        <div id="badge" class="hidden absolute top-4 right-6 text-sm px-3 py-2 rounded-lg bg-zinc-100 text-zinc-700 font-medium" aria-live="polite"></div>
        
        <!-- Loader moved to report pane so it doesn't block the form suggestion UI -->
        <div id="report_loader" class="hidden absolute inset-0 z-10 bg-white/70 flex items-center justify-center">
          <div class="flex items-center gap-2">
            <svg class="animate-spin h-6 w-6 text-[#0E2018]" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
            </svg>
            <div class="text-sm text-zinc-700">Generating player report…</div>
          </div>
        </div>
        <div id="out_html" class="space-y-3" style="max-width: 100%; overflow-x: hidden;">
          <div class="text-sm text-zinc-500">Generate a report to see results here.</div>
        </div>

        <pre id="out_md" class="hidden"></pre>
      </section>

    </div>

    <!-- SIDEBAR (1/3): My Reports -->
    <aside class="space-y-4">
      <div class="space-y-0 mt-0">
          <h2 class="text-3xl font-extrabold tracking-tight section-title flex items-center gap-3">My reports <span id="reports_count" class="inline-flex items-center justify-center rounded-md bg-[#6FD06B]/10 p-1 text-[#6FD06B] ring-1 ring-inset ring-[#6FD06B]/20 min-w-[3rem]">0</span></h2>
          <p class="text-base section-desc">Search saved reports.</p>
      </div>
      <section class="bg-white border border-zinc-200 rounded-xl p-6 shadow-sm space-y-3">
        <div class="flex items-center justify-between">
          
        </div>

        <div class="space-y-1">
          <label for="report_q" class="block text-sm font-medium">Search</label>
          <input id="report_q" type="text" placeholder="Search by player, position, team, league…"
            class="w-full rounded-md border bg-white border-zinc-300 px-3 py-2 text-sm shadow-sm focus:outline-none focus:ring-2 focus:ring-[#6FD06B]" />
          <div class="text-xs text-zinc-500">
            Try: Guard, Euroleague
          </div>
        </div>

        <div class="border-t border-zinc-200 pt-4">
          <div id="reports_list" class="space-y-1">
            <div class="text-sm text-zinc-500">Loading…</div>
          </div>
        </div>
      </section>
    </aside>
  </div>

  <!-- Credits Modal -->
  <div id="credits_modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/50">
    <div class="bg-white rounded-xl shadow-xl max-w-md w-full mx-4 p-6">
      <div class="flex items-start justify-between mb-4">
        <h3 class="text-2xl font-bold">Buy credits</h3>
        <button type="button" id="close_credits_modal" class="text-zinc-400 hover:text-zinc-600">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
      
      <div class="space-y-4">
        <div class="flex items-start justify-between gap-3 p-4 bg-zinc-50 rounded-lg">
          <div>
            <div class="text-sm text-zinc-500">Current balance</div>
            <div id="modal_credits_badge" class="text-3xl font-extrabold text-[#6FD06B]">—</div>
            <div class="text-xs text-zinc-500 mt-1">1 credit = €1</div>
          </div>
        </div>

        <div class="flex flex-col gap-2">
          <button type="button" id="modal_buy5" class="btn-primary w-full">
            Buy 5 credits
          </button>

          <button type="button" id="modal_buy10" class="btn-primary w-full">
            Buy 10 credits
          </button>

          <div class="flex gap-2 items-center">
            <input id="modal_custom_credits" type="number" min="1" max="1000" value="5"
              class="flex-1 rounded-md border bg-white border-zinc-300 px-3 py-2 text-sm shadow-sm focus:outline-none focus:ring-2 focus:ring-[#6FD06B]" />
            <button type="button" id="modal_buyCustom" class="btn-primary whitespace-nowrap">
              Buy custom
            </button>
          </div>
        </div>

        <div id="modal_buy_err" class="text-sm text-red-600"></div>
      </div>
    </div>
  </div>

</main>
{% endblock %}

{% block scripts %}
<script>
  (function() {
    // Debounce report search input
    const reportQ = document.getElementById('report_q');
    if (reportQ) {
      let timer = null;
      reportQ.addEventListener('input', function () {
        if (timer) clearTimeout(timer);
        timer = setTimeout(() => {
          window.loadReports(reportQ.value || '');
        }, 350);
      });
    }

    const userBadge = document.getElementById("user_badge");
    if (userBadge) userBadge.style.whiteSpace = "nowrap";
    const loginLink = document.getElementById("login_link");
    const logoutBtn = document.getElementById("logout_btn");
    const creditsModal = document.getElementById("credits_modal");
    const runBtn = document.getElementById("run");
    let currentCredits = null;
    let _lastRenderedToken = null; // Prevent double-render flicker when auth fires twice
    let _isRenderingSession = false; // Gate to avoid overlapping renders

    if (!window.sb || !window.sb.auth) {
      console.warn("Supabase not ready");
      if (userBadge) userBadge.textContent = "Loading...";
      return;
    }

    // Debug: log element references
    // DOM elements loaded

    async function fetchCredits(accessToken) {
      if (!accessToken) return null;
      try {
        const response = await fetch('/api/credits', {
          headers: { Authorization: `Bearer ${accessToken}` }
        });
        if (!response.ok) return null;
        const data = await response.json();
        // Support both shapes: {credits} and {credits_remaining}
        const value = data.credits_remaining ?? data.credits;
        return value ?? null;
      } catch (err) {
        console.error('[fetchCredits] error:', err);
        return null;
      }
    }

    function renderLoggedOut() {
      userBadge.textContent = "";
      loginLink.style.display = "inline";
      logoutBtn.style.display = "none";
      if (runBtn) runBtn.textContent = "Generate report";
    }

    function renderLoggedIn(session, credits = null) {
      loginLink.style.display = "none";
      logoutBtn.style.display = "inline";
      updateCreditsUI(credits, session);
    }

    function updateCreditsUI(credits, session) {
      if (!userBadge) return;
      
      const email = session?.user?.email || "User";
      const name = email.split('@')[0];
      const creditsText = credits !== null && credits !== undefined ? credits : "—";
      const creditWord = credits === 1 ? 'credit' : 'credits';

      // Always ensure the bubble structure exists first
      const existingLink = document.getElementById("topup_link");
      
      if (!existingLink) {
        // Initial render: create full structure once
        const html = `<span style="font-size: 0.875rem;">Hi ${name}! You have <a href="#" id="topup_link" style="color: rgb(37, 99, 235); font-weight: 600; font-size: 0.875rem;">${creditsText}\u00A0${creditWord}</a>.</span>`;
        userBadge.innerHTML = html;
        
        // Setup click handler (only on initial render)
        const link = document.getElementById("topup_link");
        if (link) {
          link.onclick = (e) => {
            e.preventDefault();
            try {
              window.trackClientEvent?.('credits_modal_opened', {
                credits: currentCredits,
                source: 'speech_bubble'
              });
            } catch (err) {}
            if (creditsModal) creditsModal.classList.remove("hidden");
          };
          link.onmouseover = (e) => {
            e.target.style.textDecoration = 'underline';
          };
          link.onmouseout = (e) => {
            e.target.style.textDecoration = 'none';
          };
        }
      } else {
        // Update only: just change the text content of existing link
        existingLink.textContent = `${creditsText}\u00A0${creditWord}`;
      }
      
      // Update modal badge
      const modalCredits = document.getElementById("modal_credits_badge");
      if (modalCredits) {
        modalCredits.textContent = creditsText;
      }
      
      // Update Generate button
      if (runBtn) {
        runBtn.textContent = credits === 0 ? "Top-up to generate report" : "Generate report";
      }
    }

    async function refreshCreditsForSession(session) {
      if (!session?.access_token) {
        currentCredits = null;
        if (runBtn) runBtn.textContent = "Generate report";
        return;
      }
      
      const credits = await fetchCredits(session.access_token);
      currentCredits = credits;
      updateCreditsUI(credits, session);
    }

    async function renderSession(session) {
      if (_isRenderingSession) return;
      _isRenderingSession = true;
      try {
        if (!session) {
          currentCredits = null;
          _lastRenderedToken = null;
          renderLoggedOut();
          window.loadReports("");
          return;
        }

        const token = session.access_token;
        if (token && token === _lastRenderedToken) {
          return;
        }

        const credits = await fetchCredits(token);
        currentCredits = credits;
        renderLoggedIn(session, credits);
        _lastRenderedToken = token;
        window.loadReports("");
      } finally {
        _isRenderingSession = false;
      }
    }

    // Expose a simple synchronous function to update credits display
    window.updateCreditsDisplay = function(newCredits) {
      currentCredits = newCredits;
      // Get cached session synchronously
      const session = window._currentSession;
      if (session) {
        updateCreditsUI(newCredits, session);
      }
    };

    // Expose for other code paths (app.js + checkout + reports)
    window.getAccessToken = async function () {
      if (!window.sb || !window.sb.auth) return null;
      const { data } = await window.sb.auth.getSession();
      return data?.session?.access_token || null;
    };

    // Removed logoutBtn click handler to let base.html handle logout globally
    // logoutBtn?.addEventListener("click", () => {
    //   try { window.sb.auth.signOut().catch(() => {}); } catch (e) {}
    //   // Redirect immediately to the public landing
    //   window.location.replace('/');
    // });

    // ---- Reports sidebar ----
    let _lastReportOpen = { id: null, ts: 0 };
    let _openReportMutex = false;
    async function openReport(reportId) {
      const err = document.getElementById("err");
      if (err) err.textContent = "";

      // Prevent concurrent execution
      if (_openReportMutex) return;
      _openReportMutex = true;

      // Guard against rapid double-click/tap on the same report
      try {
        const now = Date.now();
        const rid = String(reportId);
        if (_lastReportOpen.id === rid && (now - _lastReportOpen.ts) < 800) {
          _openReportMutex = false;
          return;
        }
        _lastReportOpen = { id: rid, ts: now };
      } catch (e) {}

      const loader = document.getElementById("report_loader");

      try {
        const token = await window.getAccessToken?.();
        if (!token) {
          if (err) err.textContent = "Login to load saved reports.";
          return;
        }

        if (loader) loader.classList.remove("hidden");

        const r = await fetch(`/api/reports/${reportId}`, {
          headers: { Authorization: `Bearer ${token}` }
        });
        const j = await r.json().catch(() => ({}));
        if (!r.ok) {
          if (err) err.textContent = j.error || "Failed to load report";
          return;
        }

        const out = document.getElementById("out_html");
        if (out) {
          const renderFn = window.renderReport;
          if (typeof renderFn === "function") {
            out.innerHTML = renderFn(j);
          } else {
            const esc = (s) => String(s || "").replace(/[&<>]/g, (c) => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;' }[c] || c));
            const html = j.report_html || "";
            out.innerHTML = html || `<pre class="text-sm">${esc(j.report_md || "")}</pre>`;
          }
        }

        const status = document.getElementById("status");
        if (status) status.textContent = "";
      } catch (renderError) {
        if (err) err.textContent = "Failed to load report.";
      } finally {
        if (loader) loader.classList.add("hidden");
        _openReportMutex = false;
      }
    }

    const reportsState = {
      items: [],
      total: null,
      offset: 0,
      pageSize: 30,
      loading: false,
      done: false,
      q: "",
      token: null,
    };
    let reportsObserver = null;

    function updateReportsBadge(total) {
      const count = document.getElementById("reports_count");
      if (!count) return;
      // Always show a number, with min-width preventing collapse
      if (Number.isFinite(total)) {
        count.textContent = `${total}`;
      } else {
        count.textContent = `${reportsState.items.length}`;
      }
    }

          function setupReportsObserver() {
            const sentinel = document.getElementById("reports_load_more_sentinel");
            if (!sentinel || reportsState.done) return;

            if (reportsObserver) {
              reportsObserver.disconnect();
            }

            reportsObserver = new IntersectionObserver((entries) => {
              if (entries.some(e => e.isIntersecting)) {
                fetchAndRenderReports();
              }
            }, { root: null, rootMargin: "0px 0px 200px 0px" });

            reportsObserver.observe(sentinel);
          }

          function renderReportsList() {
            const list = document.getElementById("reports_list");
            if (!list) return;

            if (!reportsState.items.length && reportsState.done) {
              list.innerHTML = `<div class="text-sm text-zinc-500">No saved reports yet.</div>`;
              updateReportsBadge(0);
              return;
            }

            const html = reportsState.items.map(it => {
              let dateStr = "";
              if (it.created_at) {
                try {
                  const d = new Date(it.created_at);
                  dateStr = d.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
                } catch (e) {
                  dateStr = it.created_at.split('T')[0];
                }
              }
              return `
              <button
                type="button"
                class="report-item w-full text-left text-sm px-3 py-2 rounded-md border border-zinc-200 hover:bg-zinc-50"
                data-report-id="${it.id}">
                <div class="font-medium">${it.player_name || "Report"}</div>
                ${it.position ? `<div class="text-xs text-zinc-500">${it.position}</div>` : ''}
              </button>
            `;
            }).join("");

            const sentinel = reportsState.done ? "" : `<div id="reports_load_more_sentinel" class="py-2 text-center text-xs text-zinc-500">Loading more…</div>`;
            list.innerHTML = html + sentinel;

            const nodes = Array.from(list.querySelectorAll("button[data-report-id]"));
            requestAnimationFrame(() => nodes.forEach(n => n.classList.add('visible')));

            setupReportsObserver();
          }

          async function fetchAndRenderReports() {
            if (reportsState.loading || reportsState.done) return;

            const list = document.getElementById("reports_list");
            const count = document.getElementById("reports_count");
            if (!list) return;

            const token = reportsState.token || await window.getAccessToken?.();
            if (!token) {
              list.innerHTML = `<div class="text-sm text-zinc-500">Login to see your saved reports.</div>`;
              if (count) count.textContent = "0";
              reportsState.done = true;
              return;
            }

            reportsState.token = token;
            reportsState.loading = true;

            const url = new URL("/api/reports", window.location.origin);
            url.searchParams.set("limit", String(reportsState.pageSize));
            url.searchParams.set("offset", String(reportsState.offset));
            if (reportsState.q) url.searchParams.set("q", reportsState.q);

            const r = await fetch(url.toString(), {
              headers: { Authorization: `Bearer ${token}` }
            });

            const j = await r.json().catch(() => ({}));
            if (!r.ok) {
              list.innerHTML = `<div class="text-sm text-red-600">${j.error || "Failed to load reports"}</div>`;
              if (count) count.textContent = "0";
              reportsState.loading = false;
              reportsState.done = true;
              return;
            }

            const items = Array.isArray(j.items) ? j.items : [];
            const total = Number(j.total);
            if (Number.isFinite(total)) {
              reportsState.total = total;
            }

            reportsState.items = reportsState.items.concat(items);
            reportsState.offset += items.length;

            if (reportsState.total !== null) {
              updateReportsBadge(reportsState.total);
              if (reportsState.offset >= reportsState.total) {
                reportsState.done = true;
              }
            } else {
              updateReportsBadge(reportsState.items.length);
            }

            if (items.length < reportsState.pageSize) {
              reportsState.done = true;
            }

            renderReportsList();
            reportsState.loading = false;
          }

          window.loadReports = async function loadReports(q = "") {
            const list = document.getElementById("reports_list");
            const count = document.getElementById("reports_count");
            if (!list) return;

            // reset state
            reportsState.items = [];
            reportsState.total = null;
            reportsState.offset = 0;
            reportsState.loading = false;
            reportsState.done = false;
            reportsState.q = q;
            reportsState.token = null;

            // clear badge and show skeleton
            if (count) count.textContent = "0";
            list.innerHTML = `
              <div class="reports-skeleton" aria-hidden="true">
                <div class="s-item"></div>
                <div class="s-item"></div>
                <div class="s-item"></div>
                <div class="s-item"></div>
              </div>
            `;
            try { list.style.minHeight = '240px'; } catch (e) {}

            if (reportsObserver) {
              reportsObserver.disconnect();
              reportsObserver = null;
            }

            // Fetch first page; subsequent pages load on scroll
              await fetchAndRenderReports();
            };


    // Set up delegated click handler once for the reports list
    const reportsList = document.getElementById("reports_list");
    if (reportsList && !reportsList._handlerAttached) {
      reportsList._handlerAttached = true;
      reportsList.onclick = function (e) {
        try {
          const btn = (e.target && e.target.closest) ? e.target.closest('button[data-report-id]') : null;
          if (btn) {
            openReport(btn.dataset.reportId);
          }
        } catch (err) {}
      };
    }

    // Debounced search with search_initiated event (fires after typing pause)
    let _rt = null;
    let _searchInitiated = false;
    let _lastTrackedQuery = "";
    const _searchInitiatedDebounceMs = 500;
    let _initTimer = null;
    document.getElementById("report_q")?.addEventListener("input", (e) => {
      const query = e.target.value.trim();

      // Reset search session when input is cleared
      if (!query) {
        _searchInitiated = false;
        _lastTrackedQuery = "";
      }

      // Debounce the initial search event and track only when query changes
      clearTimeout(_initTimer);
      if (query) {
        _initTimer = setTimeout(() => {
          if (!_searchInitiated || query !== _lastTrackedQuery) {
            _searchInitiated = true;
            _lastTrackedQuery = query;
            try {
              window.trackClientEvent?.('search_initiated', { initial_query: query });
            } catch (err) {}
          }
        }, _searchInitiatedDebounceMs);
      }

      // Debounce the list fetch separately (quicker)
      clearTimeout(_rt);
      _rt = setTimeout(() => window.loadReports(query), 250);
    });

    // Initial render
    (async () => {
      if (!window.sb || !window.sb.auth) return;
      const { data } = await window.sb.auth.getSession();
      const session = data?.session || null;
      window._currentSession = session; // Cache for synchronous access

      await renderSession(session);
    })();

    // Auth changes
    if (window.sb && window.sb.auth) {
      window.sb.auth.onAuthStateChange(async (_event, session) => {
        window._currentSession = session; // Cache for synchronous access
        await renderSession(session);
      });
    }

    // Intercept run button click when credits are 0
    if (runBtn) {
      runBtn.addEventListener('click', (e) => {
        if (currentCredits === 0) {
          e.preventDefault();
          e.stopImmediatePropagation();
          // Track modal open from zero-credit button
          try {
            window.trackClientEvent?.('credits_modal_opened', {
              credits: 0,
              source: 'generate_button_zero_credits'
            });
          } catch (err) {}
          if (creditsModal) creditsModal.classList.remove("hidden");
        }
      }, true); // use capture phase to intercept before app.js handler
    }
  })();
</script>

<!-- Stripe checkout helper -->
<script>
  // Modal controls
  document.getElementById("close_credits_modal")?.addEventListener("click", () => {
    const modal = document.getElementById("credits_modal");
    if (modal) modal.classList.add("hidden");
  });

  // Close modal on backdrop click
  document.getElementById("credits_modal")?.addEventListener("click", (e) => {
    if (e.target.id === "credits_modal") {
      e.target.classList.add("hidden");
    }
  });

  async function startCheckout(credits, errId) {
    const err = document.getElementById(errId || "modal_buy_err");
    if (err) err.textContent = "";

    const n = parseInt(String(credits || 0), 10);
    if (!Number.isFinite(n) || n <= 0 || n > 1000) {
      if (err) err.textContent = "Enter a number between 1 and 1000.";
      return;
    }

    const token = await window.getAccessToken?.();
    if (!token) {
      window.location.href = "/login";
      return;
    }

    const r = await fetch("/api/stripe/create-checkout-session", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": `Bearer ${token}`
      },
      body: JSON.stringify({ credits: n })
    });

    const j = await r.json().catch(() => ({}));
    if (!r.ok) {
      if (err) err.textContent = j.error || "Failed to start checkout";
      return;
    }

    window.location.href = j.url;
  }

  // Modal buttons with event tracking
  document.getElementById("modal_buy5")?.addEventListener("click", () => {
    try {
      window.trackClientEvent?.('topup_5_clicked', { amount: 5 });
    } catch (err) {}
    startCheckout(5, "modal_buy_err");
  });
  document.getElementById("modal_buy10")?.addEventListener("click", () => {
    try {
      window.trackClientEvent?.('topup_10_clicked', { amount: 10 });
    } catch (err) {}
    startCheckout(10, "modal_buy_err");
  });
  document.getElementById("modal_buyCustom")?.addEventListener("click", () => {
    const n = parseInt(document.getElementById("modal_custom_credits").value || "0", 10);
    try {
      window.trackClientEvent?.('topup_custom_clicked', { amount: n });
    } catch (err) {}
    startCheckout(n, "modal_buy_err");
  });

  // Handle Generate button click when credits are 0
  document.getElementById("run")?.addEventListener("click", (e) => {
    const btn = e.target;
    if (btn.textContent.includes("Top-up")) {
      e.preventDefault();
      const modal = document.getElementById("credits_modal");
      if (modal) modal.classList.remove("hidden");
    }
  });


</script>

{{ super() }}
{% endblock %}
